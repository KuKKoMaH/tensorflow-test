<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    html, body {
      padding: 0;
      margin: 0;
    }

    #webcam {
      width: 100vw;
      height: 100vh;
      display: block;
    }

    #result {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      text-align: center;
      color: #ffffff;
      font-size: 22px;
    }
  </style>
</head>
<body>
<div id="result"></div>
<video id="webcam" autoplay playsinline muted></video>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script>
  /*! modernizr 3.6.0 (Custom Build) | MIT *
   * https://modernizr.com/download/?-getusermedia-setclasses !*/
  !function ( e, n, s ) {
    function a( e ) {
      var n = r.className, s = Modernizr._config.classPrefix || "";
      if (c && (n = n.baseVal), Modernizr._config.enableJSClass) {
        var a = new RegExp("(^|\\s)" + s + "no-js(\\s|$)");
        n = n.replace(a, "$1" + s + "js$2");
      }
      Modernizr._config.enableClasses && (n += " " + s + e.join(" " + s), c ? r.className.baseVal = n : r.className = n);
    }

    function o( e, n ) {return typeof e === n;}

    function i() {
      var e, n, s, a, i, l, r;
      for (var c in f) if (f.hasOwnProperty(c)) {
        if (e = [], n = f[c], n.name && (e.push(n.name.toLowerCase()), n.options && n.options.aliases && n.options.aliases.length)) for (s = 0; s < n.options.aliases.length; s++) e.push(n.options.aliases[s].toLowerCase());
        for (a = o(n.fn, "function") ? n.fn() : n.fn, i = 0; i < e.length; i++) l = e[i], r = l.split("."), 1 === r.length ? Modernizr[r[0]] = a : (!Modernizr[r[0]] || Modernizr[r[0]] instanceof Boolean || (Modernizr[r[0]] = new Boolean(Modernizr[r[0]])), Modernizr[r[0]][r[1]] = a), t.push((a ? "" : "no-") + r.join("-"));
      }
    }

    var t        = [], f = [], l = {
      _version:     "3.6.0",
      _config:      { classPrefix: "", enableClasses: !0, enableJSClass: !0, usePrefixes: !0 },
      _q:           [],
      on:           function ( e, n ) {
        var s = this;
        setTimeout(function () {n(s[e]);}, 0);
      },
      addTest:      function ( e, n, s ) {f.push({ name: e, fn: n, options: s });},
      addAsyncTest: function ( e ) {f.push({ name: null, fn: e });},
    }, Modernizr = function () {};
    Modernizr.prototype = l, Modernizr = new Modernizr;
    var r = n.documentElement, c = "svg" === r.nodeName.toLowerCase();
    Modernizr.addTest("getUserMedia", "mediaDevices" in navigator && "getUserMedia" in navigator.mediaDevices), i(), a(t), delete l.addTest, delete l.addAsyncTest;
    for (var d = 0; d < Modernizr._q.length; d++) Modernizr._q[d]();
    e.Modernizr = Modernizr;
  }(window, document);
</script>
<script type="text/javascript">
  const webcam = document.getElementById('webcam');
  const resultEl = document.getElementById('result');

  const initWebcam = () => new Promise(( resolve, reject ) => {
    const navigatorAny = navigator;
    const adjustVideoSize = ( width, height ) => {
      const aspectRatio = width / height;
      if (width >= height) {
        webcam.width = aspectRatio * webcam.height;
      } else if (width < height) {
        webcam.height = webcam.width / aspectRatio;
      }
    };
    // navigator.getUserMedia = (navigator.getUserMedia ||
    //   navigator.webkitGetUserMedia ||
    //   navigator.mozGetUserMedia ||
    //   navigator.msGetUserMedia);

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {


      navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" }, width: 224, height: 224 },
        audio: false,
      })
        .catch(e => {
          console.log(e);
          return navigator.mediaDevices.getUserMedia({ 'video': { width: 224, height: 224 }, 'audio': false });
        })
        .then(stream => {
          webcam.srcObject = stream;
          webcam.addEventListener('loadeddata', () => {
            // adjustVideoSize(
            //   webcam.videoWidth,
            //   webcam.videoHeight);
            resolve();
          }, false);
        })
        .catch(reject);
    } else {
      reject('navigator.getUserMedia not found');
    }
  });

  initWebcam()
    .then(() => tf.loadGraphModel("cats_and_dogs_imagenet_js/model.json"))
    .then(model => {

      const predict = () => tf.tidy(() => {
        const webcamImage = tf.browser.fromPixels(webcam);
        const batchedImage = webcamImage.expandDims(0);
        const input = batchedImage.toFloat().div(tf.scalar(127)).sub(tf.scalar(1));

        const result = model.predict(input);
        const predictions = result.dataSync();
        console.log(predictions);
        resultEl.innerText = predictions[0] > .5 ? 'кисулькен' : 'не кисулькен';

        // requestAnimationFrame(predict);
        setTimeout(predict, 1000);
      });
      predict();
    })
    .catch(e => console.error(e));
  // let model, webcam, labelContainer, maxPredictions;
  //
  // // Load the image model and setup the webcam
  // async function init() {
  //   const modelURL = URL + "model.json";
  //   const metadataURL = URL + "metadata.json";
  //
  //   // load the model and metadata
  //   // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
  //   // or files from your local hard drive
  //   // Note: the pose library adds "tmImage" object to your window (window.tmImage)
  //   model = await tmImage.load(modelURL, metadataURL);
  //   maxPredictions = model.getTotalClasses();
  //
  //   // Convenience function to setup a webcam
  //   const flip = true; // whether to flip the webcam
  //   webcam = new tmImage.Webcam(200, 200, flip); // width, height, flip
  //   await webcam.setup(); // request access to the webcam
  //   await webcam.play();
  //   window.requestAnimationFrame(loop);
  //
  //   // append elements to the DOM
  //   document.getElementById("webcam-container").appendChild(webcam.canvas);
  //   labelContainer = document.getElementById("label-container");
  //   for (let i = 0; i < maxPredictions; i++) { // and class labels
  //     labelContainer.appendChild(document.createElement("div"));
  //   }
  // }
  //
  // async function loop() {
  //   webcam.update(); // update the webcam frame
  //   await predict();
  //   window.requestAnimationFrame(loop);
  // }
  //
  // // run the webcam image through the image model
  // async function predict() {
  //   // predict can take in an image, video or canvas html element
  //   const prediction = await model.predict(webcam.canvas);
  //   for (let i = 0; i < maxPredictions; i++) {
  //     const classPrediction =
  //             prediction[i].className + ": " + prediction[i].probability.toFixed(2);
  //     labelContainer.childNodes[i].innerHTML = classPrediction;
  //   }
  // }
</script>
</body>
</html>
